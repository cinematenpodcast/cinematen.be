---
// Import necessary components
import BaseHead from "../../../components/BaseHead.astro";
import BaseHeader from "../../../components/BaseHeader.astro";
import BaseScript from "../../../components/BaseScript.astro";
import BaseFooter from "../../../components/BaseFooter.astro";
import BaseNavmenu from "../../../components/BaseNavmenu.astro";
import BasePodcastBanner from "../../../components/BasePodcastBanner.astro";
import BaseNieuwsItem from "../../../components/BaseNieuwsItem.astro";
import BaseHeadExclude from "../../../components/BaseHeadExclude.astro";

import { getCollection } from "astro:content";

export async function getStaticPaths() {
    // Function to extract text from TinaCMS rich-text body
    function extractTextFromBody(body) {
        if (typeof body === 'string') {
            return body;
        }
        if (body && typeof body === 'object') {
            if (body.children && Array.isArray(body.children)) {
                const extractText = (node) => {
                    if (node.type === 'text') return node.text || '';
                    if (node.children && Array.isArray(node.children)) {
                        return node.children.map(extractText).join(' ');
                    }
                    return '';
                };
                return body.children.map(extractText).join(' ').replace(/\s+/g, ' ').trim();
            }
        }
        return '';
    }
    
    // Helper function to ensure clean ID without .mdx extension
    function getCleanId(id) {
        return id ? id.replace(/\.mdx$/, '') : '';
    }
    
    const allPostsRaw = await getCollection("nieuws");
    const allPosts = allPostsRaw.map(post => ({
        url: `/nieuws/${getCleanId(post.id)}`,
        frontmatter: post.data,
        rawContent: () => {
            const body = post.data.body;
            const textContent = extractTextFromBody(body);
            if (textContent) {
                return textContent.substring(0, 200) + (textContent.length > 200 ? '...' : '');
            }
            return "";
        },
    }));
    const tagMap = new Map();
    
    // Group posts by tag
    allPosts.forEach((post) => {
        if (post.frontmatter.title && post.frontmatter.tags) {
            post.frontmatter.tags.forEach((tag) => {
                const formattedTag = tag.toLowerCase().replace(/:/g, '');
                if (!tagMap.has(formattedTag)) {
                    tagMap.set(formattedTag, []);
                }
                tagMap.get(formattedTag).push(post);
            });
        }
    });
    
    // Return an array of tag paths with their associated posts
    return Array.from(tagMap.entries()).map(([tag, posts]) => ({
        params: { tag },
        props: { posts }
    }));
}

const { tag } = Astro.params;

// Instant HTTP 301 redirect - no visible redirect page
return new Response(null, {
    status: 301,
    headers: {
        'Location': `/nieuws/tags/${tag}/1`,
        'Cache-Control': 'public, max-age=31536000, immutable',
    },
});
