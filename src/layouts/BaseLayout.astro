---
import BaseHead from "../components/BaseHead.astro";
import BaseHeader from "../components/BaseHeader.astro";
// import BaseScript from "../components/BaseScript.astro";
import BaseFooter from "../components/BaseFooter.astro";
import NewNavmenu from "../components/NewNavmenu.astro";
import BasePodcastBanner from "../components/BasePodcastBanner.astro";
import BaseAdBanner from "../components/BaseAdBanner.astro";
import CategoriesNieuws from "../components/CategoriesNieuws.astro";
import CategoriesReviews from "../components/CategoriesReviews.astro";
import BaseNieuwsItem from "../components/BaseNieuwsItem.astro";
import BasePodcastBlock from "../components/BasePodcastBlock.astro";
import BaseFeaturedItem from "../components/BaseFeaturedItem.astro";
import BaseReviewItem from "../components/BaseReviewItem.astro";
import BaseAbout from "../components/BaseAbout.astro";
import BaseContact from "../components/BaseContact.astro";

import { getCollection } from "astro:content";
import { readFileSync } from "fs";
import { join } from "path";

// Function to extract text from TinaCMS rich-text body
function extractTextFromBody(body) {
    if (!body) return '';
    
    // If it's already a string, return it (strip markdown if needed)
    if (typeof body === 'string') {
        // Remove markdown syntax
        return body
            .replace(/---[\s\S]*?---/g, '') // Remove frontmatter
            .replace(/#{1,6}\s+/g, '') // Remove headers
            .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links
            .replace(/\*\*([^*]+)\*\*/g, '$1') // Remove bold
            .replace(/\*([^*]+)\*/g, '$1') // Remove italic
            .replace(/\s+/g, ' ') // Normalize whitespace
            .trim();
    }
    
    // If it's an object with children array (TinaCMS rich-text structure)
    if (body && typeof body === 'object') {
        // Check for TinaCMS rich-text structure
        if (body.children && Array.isArray(body.children)) {
            const extractText = (node) => {
                if (!node) return '';
                
                // Text node
                if (node.type === 'text' && node.text) {
                    return node.text;
                }
                
                // Node with children
                if (node.children && Array.isArray(node.children)) {
                    return node.children.map(extractText).filter(Boolean).join(' ');
                }
                
                return '';
            };
            
            const extracted = body.children
                .map(extractText)
                .filter(Boolean)
                .join(' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            if (extracted) return extracted;
        }
        
        // Try to find text in any nested structure
        try {
            const stringified = JSON.stringify(body);
            // Extract all text values from the JSON
            const textMatches = stringified.match(/"text"\s*:\s*"([^"]+)"/g);
            if (textMatches && textMatches.length > 0) {
                return textMatches
                    .map(m => {
                        const match = m.match(/"text"\s*:\s*"([^"]+)"/);
                        return match ? match[1] : '';
                    })
                    .filter(Boolean)
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // Fallback: try to extract any string values that look like content
            const allStringMatches = stringified.match(/"([^"]{20,})"/g);
            if (allStringMatches) {
                // Filter out URLs, paths, etc. and get text-like content
                const contentStrings = allStringMatches
                    .map(m => m.replace(/"/g, ''))
                    .filter(s => 
                        s.length > 20 && 
                        !s.startsWith('http') && 
                        !s.startsWith('/') &&
                        !s.includes('@') &&
                        s.match(/[a-zA-Z]{3,}/) // Contains at least one word
                    );
                if (contentStrings.length > 0) {
                    return contentStrings.slice(0, 3).join(' ').substring(0, 200);
                }
            }
        } catch (e) {
            // Ignore errors
        }
    }
    
    return '';
}

// Function to extract text from MDX file for preview (fallback if bodyPreview is not available)
function extractTextFromMDXFile(slug) {
    try {
        // Remove .mdx extension if present, then add it back to ensure correct path
        const cleanSlug = slug.replace(/\.mdx$/, "");
        const filePath = join(process.cwd(), "src/content/nieuws", `${cleanSlug}.mdx`);
        const content = readFileSync(filePath, "utf-8");
        if (!content || content.trim().length === 0) {
            return "";
        }
        
        // Remove frontmatter (more robust regex)
        const withoutFrontmatter = content.replace(/^---[\s\S]*?---\s*\n\n?/m, "");
        
        // Remove markdown syntax
        const text = withoutFrontmatter
            .replace(/#{1,6}\s+/g, "") // Remove headers
            .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1") // Convert links
            .replace(/\*\*([^*]+)\*\*/g, "$1") // Remove bold
            .replace(/\*([^*]+)\*/g, "$1") // Remove italic
            .replace(/!\[([^\]]*)\]\([^)]+\)/g, "") // Remove images
            .replace(/\s+/g, " ") // Normalize whitespace
            .trim();
        
        if (!text || text.length === 0) {
            return "";
        }
        
        return text.substring(0, 200) + (text.length > 200 ? "..." : "");
    } catch (e) {
        return "";
    }
}

// Helper function to ensure clean ID without .mdx extension
function getCleanId(id) {
    return id ? id.replace(/\.mdx$/, '') : '';
}

const allNieuwsPostsRaw = (await getCollection("nieuws")).filter(post => !post.data.draft);
const allNieuwsPosts = allNieuwsPostsRaw.map((post) => {
    // Try bodyPreview first, then extract from body, then extract from MDX file directly
    let contentPreview = post.data.bodyPreview || extractTextFromBody(post.data.body) || "";
    
    // If still empty, try reading the MDX file directly
    if (!contentPreview && post.id) {
        const isFirstPost = allNieuwsPostsRaw.indexOf(post) === 0;
        if (isFirstPost) {
            console.log('\n=== DEBUG EXTRACT FROM FILE ===');
            console.log('post.id:', post.id);
            console.log('process.cwd():', process.cwd());
        }
        contentPreview = extractTextFromMDXFile(post.id);
        if (isFirstPost) {
            console.log('contentPreview after extractTextFromMDXFile:', contentPreview.substring(0, 100));
            console.log('===============================\n');
        }
    }
    
    return {
        url: `/nieuws/${getCleanId(post.id)}`,
        frontmatter: post.data,
        rawContent: contentPreview,
    };
});

const allRnbPostsRaw = await getCollection("reviews");
const allRnbPosts = allRnbPostsRaw.map(post => ({
    url: `/reviews&blogs/${getCleanId(post.id)}`,
    frontmatter: post.data,
    rawContent: () => post.body || "",
}));

// Generate canonical URL for homepage
const canonicalURL = `https://cinematen.be${Astro.url.pathname}`;

// Function to truncate content to 200 characters with "..."
function truncateContent(content, maxLength = 200) {
    if (!content || typeof content !== 'string') return '';
    // Strip HTML tags and normalize whitespace
    const text = content.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '...';
}

---

<html lang="nl">
    <head>
        <BaseHead canonicalURL={canonicalURL} />
    </head>
    <body class="body">
        <div class="page-wrapper">
            <NewNavmenu />
            <BaseHeader />
            <main class="content">
                <section class="nieuws-section">
                    <h1 class="nieuws-title">Film & TV nieuws</h1>
                    <div class="container">
                        <div class="w-layout-grid blog-grid">
                            <div class="content-left">
                                {allNieuwsPosts
                                    .sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime())
                                    .slice(0, 5)
                                    .map((post) => (
                                        <article>
                                            <BaseNieuwsItem
                                                key={post.url}
                                                url={post.url}
                                                title={post.frontmatter.title}
                                                thumbnail={post.frontmatter.thumbnail}
                                                date={post.frontmatter.date}
                                                content={post.rawContent || ""}
                                            />
                                        </article>
                                    ))}
                                <nav>
                                    <a href="/nieuws" class="next-button">
                                        <div class="title-medium">Meer nieuws</div>
                                    </a>
                                </nav>
                            </div>
                            <aside class="content-right">
                                <div class="stick-wrapper">
                                    <BaseAdBanner />
                                    <BasePodcastBlock />
                                    <section class="featured-articles">
                                        <h2 class="title-large xtra">Uitgelicht</h2>
                                        <div class="featured-block">
                                            {allRnbPosts
                                                .filter(post => post.frontmatter.featured)
                                                .sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime())
                                                .slice(0, 5)
                                                .map((post) => (
                                                    <article>
                                                        <BaseFeaturedItem
                                                            key={post.url}
                                                            url={post.url}
                                                            title={post.frontmatter.title}
                                                            thumbnail={post.frontmatter.thumbnail}
                                                            date={post.frontmatter.date}
                                                            featured={post.frontmatter.featured}
                                                            rating={post.frontmatter.rating}
                                                            asLink={true}
                                                            square={true}
                                                        />
                                                    </article>
                                                ))}                                        
                                        </div>
                                    </section>
                                    <CategoriesNieuws />
                                </div>
                            </aside>
                        </div>
                    </div>
                </section>
                {/* Desktop banner - shown between sections */}
                <div class="ad-banner-desktop">
                    <BaseAdBanner />
                </div>
                <BasePodcastBanner />
                <section class="reviews-section">
                    <div class="container">
                        <h1 class="nieuws-title">Reviews & Blogs</h1>
                        <div class="w-layout-grid blog-grid">
                            <div class="content-left">
                                {allRnbPosts
                                    .sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime())
                                    .slice(0, 5)
                                    .map((post) => (
                                        <article>
                                            <BaseReviewItem
                                                key={post.url}
                                                url={post.url}
                                                schrijver={post.frontmatter.schrijver}
                                                title={post.frontmatter.title}
                                                thumbnail={post.frontmatter.thumbnail}
                                                date={post.frontmatter.date}
                                                summary={post.frontmatter.summary}
                                                rating={post.frontmatter.rating}
                                            />
                                        </article>
                                    ))}
                                <nav>
                                    <a href="/reviews&blogs" class="next-button">
                                        <div class="title-medium">Meer Reviews & Blogs</div>
                                    </a>
                                </nav>           
                            </div>
                            <aside class="content-right">
                                <div class="stick-wrapper">
                                    <section class="featured-articles">
                                        <h2 class="title-large xtra">Cinematen Top 5</h2>
                                        <div class="featured-block">
                                            {allRnbPosts
                                                .filter(post => post.frontmatter.rating !== undefined)
                                                .filter(post => post.frontmatter.rating !== null)
                                                .sort((a, b) => {
                                                    const ratingA = parseFloat(a.frontmatter.rating) || 0;
                                                    const ratingB = parseFloat(b.frontmatter.rating) || 0;
                                                    if (ratingB !== ratingA) {
                                                        return ratingB - ratingA;
                                                    }
                                                    return new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime();
                                                })
                                                .slice(0, 5)
                                                .map((post) => (
                                                    <article>
                                                        <BaseFeaturedItem
                                                            key={post.url}
                                                            url={post.url}
                                                            title={post.frontmatter.title}
                                                            thumbnail={post.frontmatter.thumbnail}
                                                            date={post.frontmatter.date}
                                                            featured={post.frontmatter.featured}
                                                            rating={post.frontmatter.rating}
                                                            asLink={true}
                                                            square={true}
                                                        />
                                                    </article>
                                                ))}
                                        </div>
                                    </section>
                                    <CategoriesReviews />
                                </div>
                            </aside>
                        </div>
                    </div>
                </section>
            </main>
            <BaseAbout id="over-ons"/>
            <BaseContact />
            <BaseFooter />
        </div>
        {/* BaseScript verwijderd voor performance op homepage */}
    </body>
</html>