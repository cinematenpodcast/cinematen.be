---
// Import necessary components
import BaseHead from "../../../components/BaseHead.astro";
import BaseHeader from "../../../components/BaseHeader.astro";
import BaseScript from "../../../components/BaseScript.astro";
import BaseFooter from "../../../components/BaseFooter.astro";
import NewNavmenu from "../../../components/NewNavmenu.astro";
import BasePodcastBanner from "../../../components/BasePodcastBanner.astro";
import BaseReviewItem from "../../../components/BaseReviewItem.astro";
import BaseHeadExclude from "../../../components/BaseHeadExclude.astro";
import { getCollection } from "astro:content";

// Helper function to ensure clean ID without .mdx extension
function getCleanId(id) {
  return id ? id.replace(/\.mdx$/, '') : '';
}

export async function getStaticPaths () {
  // Get all reviews from content collection
  const allPostsRaw = await getCollection("reviews");
  const allPosts = allPostsRaw.map(post => ({
    url: `/reviews&blogs/${getCleanId(post.id)}`,
    frontmatter: post.data,
    rawContent: () => {
      const body = post.data.body;
      if (typeof body === 'string') {
        return body.substring(0, 200) + '...';
      }
      return "";
    },
  }));

  // Build tag map
  const tagMap = new Map();
  allPosts.forEach((post) => {
    if (post.frontmatter.title && post.frontmatter.tags) {
      post.frontmatter.tags.forEach((tag) => {
        const formattedTag = tag.toLowerCase().replace(/:/g, '');
        if (!tagMap.has(formattedTag)) {
          tagMap.set(formattedTag, []);
        }
        tagMap.get(formattedTag).push(post);
      });
    }
  });

  // Return paths for each tag
  return Array.from(tagMap.entries()).map(([tag, posts]) => ({
    params: { tag },
    props: { 
      tagname: tag, 
      count: posts.length,
      tagged: posts
    }
  }));
}

// grab the selected tag from the url (dynamic [tag])
const tagname = Astro.params.tag.toLowerCase(); // Convert tagname to lowercase
const { tagged, count: tagcount } = Astro.props;

exclude_from_search: true
---

<html lang="nl">
    <head>
        <BaseHeadExclude />
    </head>
    <body class="body">
        <div class="page-wrapper">
            <NewNavmenu />
            <BaseHeader />
            <div class="content">
                <div class="container">
                    <h1 class="nieuws-title">Reviews & Blogs</h1>
                    <div class="w-layout-grid nieuws-list">
                        <div class="categories-block">
                            <div class="title-large">CategorieÃ«n</div>
                            <div class="categories-wrapper list">
                                <a href="/reviews&blogs/tags/film" class="categories-pill w-inline-block"><div class="title-small pink">Film</div></a>
                                <a href="/reviews&blogs/tags/tv" class="categories-pill w-inline-block"><div class="title-small pink">TV</div></a>
                                <a href="/reviews&blogs/tags/blog" class="categories-pill w-inline-block"><div class="title-small pink">Blog</div></a>
                                <a href="/reviews&blogs/tags/vlaams" class="categories-pill w-inline-block"><div class="title-small pink">Vlaams</div></a>
                                <a href="/reviews&blogs/tags/reality" class="categories-pill w-inline-block"><div class="title-small pink">Reality</div></a>
                                <a href="/reviews&blogs/tags/actie" class="categories-pill w-inline-block"><div class="title-small pink">Actie</div></a>
                                <a href="/reviews&blogs/tags/horror" class="categories-pill w-inline-block"><div class="title-small pink">Horror</div></a>
                                <a href="/reviews&blogs/tags/comedy" class="categories-pill w-inline-block"><div class="title-small pink">Comedy</div></a>
                            </div>
                        </div>
                        {tagged
                            .sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime())
                            .map(post => (
                                <BaseReviewItem
                                key={post.url}
                              url={post.url}
                              schrijver={post.frontmatter.schrijver}
                              title={post.frontmatter.title}
                              thumbnail={post.frontmatter.thumbnail}
                              date={post.frontmatter.date}
                              content={post.rawContent}
                              summary={post.frontmatter.summary}
                              rating={post.frontmatter.rating}
                                />
                            ))}
                        
                        
                        <!--div class="pagination-wrapper">
                            <div class="pagination">
                                {page.url.prev ? <a href={page.url.prev} class="previous-button w-inline-block"><div class="title-medium">Vorige</div></a> : null}
                                {start > 1 ? <span>... </span> : null}
                                {Array.from({ length: end - start + 1 }, (_, i) => i + start).map(number =>
                                    number === currentPage ? (
                                        <strong class="page-indicator" key={number}>{number}</strong>
                                    ) : (
                                        <a href={`/${number}`} key={number}>{number}</a>
                                    )
                                )}
                                {end < totalPages ? <span> ...</span> : null}
                                {page.url.next ? <a href={page.url.next} class="next-button w-inline-block"><div class="title-medium">Volgende</div></a> : null}
                            </div>
                        </div !-->
                    </div>
                </div>
            <BasePodcastBanner />
        </div>
        <BaseFooter />
    </body>
    <BaseScript />
</html>
