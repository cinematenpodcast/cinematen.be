---
import { getCollection } from "astro:content";
import NieuwsLayout from "../../layouts/NieuwsLayout.astro";
import client from "../../../tina/__generated__/client";
import AdminNieuws from "../../../tina/pages/AdminNieuws";

export async function getStaticPaths() {
  const posts = await getCollection("nieuws");

  const paths = [];
  
  posts.forEach((post) => {
    // Ensure post.id doesn't have .mdx extension (should be handled by content.config.ts, but double-check)
    const cleanId = post.id.replace(/\.mdx$/, '');
    
    // Use tinaInfo if available, otherwise construct relativePath from cleanId
    let relativePath = post.data.tinaInfo?.relativePath;
    
    if (!relativePath) {
      // Add .mdx back for TinaCMS queries (TinaCMS needs the file extension)
      relativePath = `${cleanId}.mdx`;
    } else {
      // Ensure relativePath doesn't have double .mdx
      if (relativePath.endsWith('.mdx.mdx')) {
        relativePath = relativePath.replace(/\.mdx\.mdx$/, '.mdx');
      }
    }
    
    // Add route without .mdx extension (clean URL) - this is the primary route
    paths.push({
      params: { slug: cleanId },
      props: {
        post,
        getTinaProps: async () =>
          client.queries.nieuws({
            relativePath: relativePath,
          }),
      },
    });
    
    // Add redirect route for URLs with .mdx extension (backward compatibility)
    // Skip redirect for posts with special characters/emoji that cause encoding issues
    // Check if slug contains non-ASCII characters that might cause problems
    const hasSpecialChars = /[^\x00-\x7F]/.test(cleanId);
    if (cleanId && cleanId.length > 0 && !hasSpecialChars) {
      paths.push({
        params: { slug: `${cleanId}.mdx` },
        props: {
          redirect: true,
          target: `/nieuws/${cleanId}`,
        },
      });
    }
  });
  
  return paths;
}

const { post, getTinaProps, redirect, target } = Astro.props;

// Handle redirects for old URLs with .mdx extension
// Use instant client-side redirect instead of server redirect to avoid flash
if (redirect && target) {
  return new Response(null, {
    status: 301,
    headers: {
      'Location': target,
      'Cache-Control': 'public, max-age=31536000, immutable',
    },
  });
}

// Ensure post exists (should always be present for non-redirect routes)
if (!post) {
  return Astro.redirect('/nieuws', 404);
}

const tinaProps = await getTinaProps();
const frontmatter = post.data;
---

<NieuwsLayout frontmatter={frontmatter}>
  <AdminNieuws {...tinaProps} client:tina />
</NieuwsLayout>
